<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almost 4 Years — Our Story</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cormorant Garamond', serif;
            overflow: hidden;
            background: #000;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Cinematic black bars */
        .cinematic-bars {
            position: fixed;
            left: 0;
            width: 100%;
            height: 60px;
            background: #000;
            z-index: 100;
            transition: transform 1s ease;
        }
        
        .cinematic-bars.top { top: 0; }
        .cinematic-bars.bottom { bottom: 0; }
        
        .cinematic-bars.hidden {
            transform: scaleY(0);
        }
        
        .scroll-container {
            position: relative;
            z-index: 10;
            height: 400vh;
        }
        
        .scene-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .text-overlay {
            text-align: center;
            color: #fff;
            opacity: 0;
            transform: scale(0.9) translateY(50px);
            transition: all 1.5s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none;
            max-width: 800px;
            padding: 2rem;
        }
        
        .text-overlay.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        .text-overlay h1 {
            font-size: clamp(3rem, 8vw, 6rem);
            font-weight: 300;
            letter-spacing: 0.3em;
            margin-bottom: 1rem;
            text-shadow: 0 0 40px rgba(255, 100, 150, 0.5);
            overflow: hidden;
        }
        
        .text-overlay h1 span {
            display: inline-block;
            opacity: 0;
            transform: translateY(100%);
            animation: revealText 0.8s forwards;
        }
        
        @keyframes revealText {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .text-overlay h2 {
            font-size: clamp(2rem, 5vw, 4rem);
            font-weight: 300;
            letter-spacing: 0.2em;
            color: #ffb6c1;
            text-shadow: 0 0 30px rgba(255, 182, 193, 0.6);
        }
        
        .text-overlay p {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            font-weight: 300;
            letter-spacing: 0.15em;
            margin-top: 2rem;
            font-style: italic;
            color: #fff0f5;
        }
        
        .heart-divider {
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff69b4, transparent);
            margin: 2rem auto;
            transition: width 1.5s ease;
        }
        
        .text-overlay.visible .heart-divider {
            width: 200px;
        }
        
        /* Progress bar */
        .scroll-progress {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 50;
            border-radius: 2px;
        }
        
        .scroll-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff69b4, #ffb6c1);
            width: 0%;
            transition: width 0.1s;
            box-shadow: 0 0 10px #ff69b4;
        }
        
        /* Skip hint */
        .skip-hint {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            letter-spacing: 0.3em;
            z-index: 50;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 2s ease;
        }
        
        .loading-heart {
            width: 60px;
            height: 60px;
            background: #ff69b4;
            position: relative;
            transform: rotate(-45deg);
            animation: heartbeat 1.5s ease infinite;
            box-shadow: 0 0 60px #ff69b4;
        }
        
        .loading-heart::before,
        .loading-heart::after {
            content: '';
            width: 60px;
            height: 60px;
            position: absolute;
            background: #ff69b4;
            border-radius: 50%;
        }
        
        .loading-heart::before { top: -30px; left: 0; }
        .loading-heart::after { left: 30px; top: 0; }
        
        @keyframes heartbeat {
            0%, 100% { transform: rotate(-45deg) scale(1); }
            50% { transform: rotate(-45deg) scale(1.1); }
        }
        
        .loading-text {
            margin-top: 60px;
            color: #ffb6c1;
            font-size: 1.2rem;
            letter-spacing: 0.5em;
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div class="loading-heart"></div>
        <div class="loading-text">LOADING OUR STORY</div>
    </div>

    <div class="cinematic-bars top"></div>
    <div class="cinematic-bars bottom"></div>

    <div id="canvas-container"></div>

    <div class="scroll-progress">
        <div class="scroll-progress-bar" id="progressBar"></div>
    </div>
    
    <div class="skip-hint">SCROLL TO BEGIN</div>

    <div class="scroll-container">
        <section class="scene-section" data-scene="0">
            <div class="text-overlay">
                <h1 id="title1">Почти 4 года…</h1>
                <div class="heart-divider"></div>
                <p>Every moment led us here</p>
            </div>
        </section>

        <section class="scene-section" data-scene="1">
            <div class="text-overlay">
                <h2>Through distance</h2>
                <h2>and time</h2>
                <div class="heart-divider"></div>
                <p>Our hearts found their way</p>
            </div>
        </section>

        <section class="scene-section" data-scene="2">
            <div class="text-overlay">
                <h2>И я до сих пор…</h2>
                <div class="heart-divider"></div>
                <p>With every beat of my heart</p>
            </div>
        </section>

        <section class="scene-section" data-scene="3">
            <div class="text-overlay">
                <h1 id="titleFinal">выбираю тебя.</h1>
                <div class="heart-divider"></div>
                <p>Today. Tomorrow. Always.</p>
            </div>
        </section>
    </div>

    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // SCENE SETUP - Cinematic dark
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050205, 0.15);
        scene.background = new THREE.Color(0x050205);

        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.4, 8);

        const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            powerPreference: "high-performance"
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 0.9;
        
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // POST PROCESSING
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloomPass = new UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            0.6, 0.8, 0.4
        );
        composer.addPass(bloomPass);

        // CINEMATIC LIGHTING - Dramatic
        const spotLight = new THREE.SpotLight(0xffd4e5, 200);
        spotLight.position.set(0, 8, 5);
        spotLight.angle = Math.PI / 6;
        spotLight.penumbra = 0.8;
        spotLight.castShadow = true;
        spotLight.shadow.mapSize.set(4096, 4096);
        spotLight.shadow.bias = -0.0001;
        scene.add(spotLight);

        const rimLight1 = new THREE.SpotLight(0xff69b4, 100);
        rimLight1.position.set(-5, 3, -3);
        scene.add(rimLight1);

        const rimLight2 = new THREE.SpotLight(0x00bfff, 80);
        rimLight2.position.set(5, 3, -3);
        scene.add(rimLight2);

        const ambientLight = new THREE.AmbientLight(0x201020, 0.5);
        scene.add(ambientLight);

        // CHARACTERS
        const tomGroup = new THREE.Group();
        const jerryGroup = new THREE.Group();
        let tomModel = null, jerryModel = null;
        let modelsLoaded = 0;

        // HEART PARTICLE SYSTEM
        const heartShape = new THREE.Shape();
        heartShape.moveTo(0, 0);
        heartShape.bezierCurveTo(0, -0.3, -0.6, -0.3, -0.6, 0);
        heartShape.bezierCurveTo(-0.6, 0.6, 0, 1.2, 0, 1.2);
        heartShape.bezierCurveTo(0, 1.2, 0.6, 0.6, 0.6, 0);
        heartShape.bezierCurveTo(0.6, -0.3, 0, -0.3, 0, 0);

        const heartGeo = new THREE.ExtrudeGeometry(heartShape, {
            depth: 0.1,
            bevelEnabled: true,
            bevelSegments: 2,
            steps: 2,
            bevelSize: 0.05,
            bevelThickness: 0.05
        });

        // GLOWING HEART between characters
        const mainHeart = new THREE.Mesh(
            heartGeo,
            new THREE.MeshStandardMaterial({
                color: 0xff1493,
                emissive: 0xff0066,
                emissiveIntensity: 2,
                roughness: 0.2,
                metalness: 0.8
            })
        );
        mainHeart.scale.set(0.3, 0.3, 0.3);
        mainHeart.position.set(0, 2, 0);
        mainHeart.rotation.x = Math.PI;
        mainHeart.visible = false;
        scene.add(mainHeart);

        // Heart particles
        const particleCount = 100;
        const heartParticles = new THREE.InstancedMesh(
            heartGeo,
            new THREE.MeshBasicMaterial({
                color: 0xff69b4,
                transparent: true,
                opacity: 0.8
            }),
            particleCount
        );
        
        const dummy = new THREE.Object3D();
        const particleData = [];
        
        for (let i = 0; i < particleCount; i++) {
            particleData.push({
                x: (Math.random() - 0.5) * 10,
                y: Math.random() * 5,
                z: (Math.random() - 0.5) * 5,
                speed: 0.01 + Math.random() * 0.02,
                scale: 0.05 + Math.random() * 0.1,
                phase: Math.random() * Math.PI * 2
            });
        }
        
        scene.add(heartParticles);

        // LOAD MODELS
        const loader = new GLTFLoader();

        function loadModel(url, group, isTom) {
            loader.load(url, (gltf) => {
                const model = gltf.scene;
                
                // Normalize scale
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const scale = 1.6 / size.y;
                model.scale.setScalar(scale);
                
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center.multiplyScalar(scale));
                model.position.y -= box.min.y * scale;
                
                // Enhance materials
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        if (child.material) {
                            child.material.roughness = 0.6;
                            child.material.metalness = 0.1;
                        }
                    }
                });
                
                group.add(model);
                
                if (isTom) {
                    tomModel = model;
                    group.position.set(-4, 0, 0);
                } else {
                    jerryModel = model;
                    group.position.set(4, 0, 0);
                }
                
                modelsLoaded++;
                if (modelsLoaded === 2) {
                    setTimeout(() => {
                        document.getElementById('loading').classList.add('hidden');
                        document.querySelectorAll('.cinematic-bars').forEach(b => b.classList.add('hidden'));
                    }, 1000);
                }
            });
        }

        loadModel(
            'https://streetfootball1v1.github.io/valentines/models/Tom.glb',
            tomGroup, true
        );
        loadModel(
            'https://streetfootball1v1.github.io/valentines/models/DJerry.glb',
            jerryGroup, false
        );

        scene.add(tomGroup);
        scene.add(jerryGroup);

        // GROUND - Reflective
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(50, 50),
            new THREE.MeshStandardMaterial({
                color: 0x0a050a,
                roughness: 0.05,
                metalness: 0.9
            })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // SCROLL SYSTEM
        let scrollProgress = 0;
        let targetScroll = 0;
        
        window.addEventListener('scroll', () => {
            const max = document.body.scrollHeight - window.innerHeight;
            targetScroll = Math.max(0, Math.min(1, window.scrollY / max));
        });

        // Text animations with letter splitting
        function splitText(element) {
            const text = element.textContent;
            element.innerHTML = '';
            text.split('').forEach((char, i) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.style.animationDelay = `${i * 0.05}s`;
                element.appendChild(span);
            });
        }

        document.querySelectorAll('h1, h2').forEach(el => splitText(el));

        // Intersection Observer
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.querySelector('.text-overlay').classList.add('visible');
                }
            });
        }, { threshold: 0.6 });

        document.querySelectorAll('.scene-section').forEach(s => observer.observe(s));

        // ANIMATION LOOP
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            
            const time = clock.getElapsedTime();
            const delta = clock.getDelta();
            
            // Smooth scroll
            scrollProgress += (targetScroll - scrollProgress) * 0.05;
            document.getElementById('progressBar').style.width = `${scrollProgress * 100}%`;
            
            const phase = scrollProgress * 3; // 0-3

            if (tomModel && jerryModel) {
                // MOVEMENT - Walking toward each other
                const startDist = 4;
                const meetDist = 0.8;
                const currentDist = THREE.MathUtils.lerp(startDist, meetDist, Math.min(phase / 2.2, 1));
                
                tomGroup.position.x = -currentDist;
                jerryGroup.position.x = currentDist;
                
                // Walking animation (bobbing)
                const walkSpeed = 8;
                const walkAmp = 0.08;
                
                if (phase < 2.2) {
                    tomGroup.position.y = Math.abs(Math.sin(time * walkSpeed)) * walkAmp;
                    jerryGroup.position.y = Math.abs(Math.sin(time * walkSpeed + 0.5)) * walkAmp;
                    
                    // Sway while walking
                    tomGroup.rotation.z = Math.sin(time * walkSpeed) * 0.03;
                    jerryGroup.rotation.z = Math.sin(time * walkSpeed + 0.5) * 0.03;
                } else {
                    // Stop and face each other
                    tomGroup.position.y = Math.sin(time * 1.5) * 0.02; // Breathing
                    jerryGroup.position.y = Math.sin(time * 1.5 + 1) * 0.02;
                    
                    // Turn to face
                    const turnAmount = Math.min((phase - 2.2) / 0.3, 1);
                    tomGroup.rotation.y = THREE.MathUtils.lerp(0, Math.PI / 2.5, turnAmount);
                    jerryGroup.rotation.y = THREE.MathUtils.lerp(0, -Math.PI / 2.5, turnAmount);
                }
                
                // Hand reaching at climax
                if (phase > 2.5) {
                    const reach = (phase - 2.5) / 0.5;
                    tomGroup.rotation.z = THREE.MathUtils.lerp(0, 0.1, reach);
                    jerryGroup.rotation.z = THREE.MathUtils.lerp(0, -0.1, reach);
                }
            }

            // CAMERA - Dramatic moves
            const baseZ = 7;
            const closeZ = 3;
            camera.position.z = THREE.MathUtils.lerp(baseZ, closeZ, Math.min(phase / 2, 1));
            
            // Slight orbit
            camera.position.x = Math.sin(time * 0.1 + phase) * 0.5;
            camera.lookAt(0, 1.2, 0);

            // MAIN HEART appears at climax
            if (phase > 2) {
                mainHeart.visible = true;
                const heartScale = Math.min((phase - 2) * 2, 1.5);
                mainHeart.scale.setScalar(0.3 * heartScale);
                mainHeart.rotation.y = time * 0.5;
                mainHeart.material.emissiveIntensity = 2 + Math.sin(time * 3) * 0.5;
            }

            // PARTICLES
            for (let i = 0; i < particleCount; i++) {
                const data = particleData[i];
                
                // Float up
                data.y += data.speed;
                if (data.y > 6) data.y = 0;
                
                // Spiral toward center at climax
                let x = data.x;
                let z = data.z;
                
                if (phase > 1.5) {
                    const attraction = (phase - 1.5) / 1.5;
                    x *= (1 - attraction * 0.5);
                    z *= (1 - attraction * 0.5);
                }
                
                dummy.position.set(
                    x + Math.sin(time + data.phase) * 0.5,
                    data.y,
                    z + Math.cos(time + data.phase) * 0.5
                );
                
                dummy.rotation.set(
                    time * 0.5,
                    time * 0.3,
                    0
                );
                
                dummy.scale.setScalar(data.scale * (1 + Math.sin(time * 2 + data.phase) * 0.3));
                dummy.updateMatrix();
                heartParticles.setMatrixAt(i, dummy.matrix);
            }
            heartParticles.instanceMatrix.needsUpdate = true;

            // LIGHTING evolution
            spotLight.intensity = 150 + phase * 50;
            spotLight.color.setHSL(0.9, 0.5, 0.8 + phase * 0.1);
            
            bloomPass.strength = 0.4 + phase * 0.4;

            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
